<MudDialog>
    <DialogContent>
        <EditForm Model=@Product OnValidSubmit=@OnValidSubmitAsync>
            <MudTextField Label="Name" HelperText="Product name"
                @bind-Value="Product.Name" For="@(() => Product.Name)"/>
            <MudTextField Label="Description" HelperText="Product description"
                @bind-Value="Product.Description" For="@(() => Product.Description)"/>
             <MudTextField Label="Description" HelperText="Product description"
                @bind-Value="Product.Description" For="@(() => Product.Description)"/>
             <MudSelect T="ProductCategory" Label="Category" Variant="Variant.Outlined" AnchorOrigin=Origin.BottomCenter>
                 @foreach (var category in Enum.GetValues<ProductCategory>())
                 {
                     <MudSelectItem T="ProductCategory" Value=@category />
                 }
             </MudSelect>
             <MudNumericField @bind-Value=Product.Quantity Label="Quantity" Variant="Variant.Text" />
             <MudNumericField @bind-Value=Product.UnitPrice Label="Unit Price" Variant="Variant.Text" />
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick=@Close Disabled=@_isSaving>Cancel</MudButton>
        <MudButton StartIcon=Icons.Filled.Save ButtonType=ButtonType.Submit Disabled=@_isSaving>
            @if (_isSaving)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2">Saving</MudText>
            }
            else
            {
                <MudText>Save</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    bool _isSaving;

    public ProductDetails Product { get; set; } = new();

    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter, EditorRequired]
    public EventCallback<ProductDetails> OnProductUpdated { get; set; }

    [Inject]
    public IDialogService DialogService { get; set; } = null!;

    public void Open()
    {
        DialogService.Show<ManageProductModal>();
    }

    public void Close() => MudDialog.Cancel();

    async Task OnValidSubmitAsync()
    {
        if (Product is not null && OnProductUpdated.HasDelegate)
        {
            try
            {
                _isSaving = true;
                await OnProductUpdated.InvokeAsync(Product);
            }
            finally
            {
                _isSaving = false;
                Close();
            }
        }
    }
}
